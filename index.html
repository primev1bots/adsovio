<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Adsgram Final Fix</title>

    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">

    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { background: #f0f2f5; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .btn { background: #007aff; color: white; padding: 15px; border-radius: 12px; width: 100%; font-weight: bold; border: none; font-size: 16px; margin-top: 20px; cursor: pointer; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .status { margin-top: 10px; font-size: 12px; color: #666; }
        .error { color: red; font-weight: bold; }
        .success { color: green; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h1 class="text-2xl font-bold mb-2">Reward Task</h1>
        <p class="text-gray-500">Watch ad to support us</p>
        
        <div id="debugArea" class="mt-4 p-2 bg-gray-100 text-xs text-left rounded hidden">
            Debug Log: <br><span id="logs"></span>
        </div>

        <button id="adBtn" onclick="showAd()" class="btn">
            Wait, Loading System...
        </button>

        <p id="statusMsg" class="status">Initializing...</p>
    </div>

    <script>
        const BLOCK_ID = "int-19079"; 
        const btn = document.getElementById('adBtn');
        const msg = document.getElementById('statusMsg');
        const logs = document.getElementById('logs');

        function log(text) {
            logs.innerHTML += text + "<br>";
            console.log(text);
        }

        // ম্যানুয়ালি স্ক্রিপ্ট লোড করার ফাংশন (Back up plan)
        function loadSdk() {
            log("Loading SDK...");
            const script = document.createElement('script');
            script.src = "https://api.adsgram.ai/js/sdk.js?v=" + new Date().getTime(); // Cache busting
            script.async = true;
            
            script.onload = () => {
                log("SDK Loaded via JS ✅");
                btn.textContent = "Watch Video Ad";
                btn.disabled = false; // Enable button
                msg.textContent = "Ready to earn!";
                msg.className = "status success";
            };

            script.onerror = () => {
                log("SDK Load Failed ❌");
                btn.textContent = "System Error";
                msg.textContent = "Internet Blocked Adsgram. Try VPN.";
                msg.className = "status error";
                document.getElementById('debugArea').classList.remove('hidden');
            };

            document.head.appendChild(script);
        }

        // পেইজ লোড হলে SDK কল হবে
        window.onload = () => {
            if(window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }
            loadSdk();
        };

        async function showAd() {
            if (!window.Adsgram) {
                Swal.fire("Error", "Network error. SDK failed to load.", "error");
                return;
            }

            btn.disabled = true;
            btn.textContent = "Playing...";

            try {
                const AdController = window.Adsgram.init({ blockId: BLOCK_ID, debug: true });
                await AdController.show().then((result) => {
                    Swal.fire("Success", "Reward Added!", "success");
                    log("Ad Watched");
                }).catch((result) => {
                    Swal.fire("Info", "Ad Skipped/Failed", "info");
                    log("Ad Error: " + JSON.stringify(result));
                });
            } catch (e) {
                log("Crash: " + e.message);
                Swal.fire("Error", "System Crash", "error");
            } finally {
                btn.disabled = false;
                btn.textContent = "Watch Video Ad";
            }
        }
    </script>
</body>
</html>
